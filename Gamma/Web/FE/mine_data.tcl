set ::heatmap_pallet {0xa50026 0xd73027 0xf46d43 0xfdae61 0xfee090 0xffffbf 0xe0f3f8 0xabd9e9 0x74add1 0x4575b4 0x313695}
set ::arrow_icon "<svg enable-background=\"new 0 0 128 128\" height=\"18px\" id=\"Layer_1\" version=\"1.1\" viewBox=\"0 0 128 128\" width=\"18px\" xml:space=\"preserve\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\"><g><g><path d=\"M64.032,13.869c-27.642,0-50.129,22.489-50.129,50.131c0.002,27.643,22.49,50.131,50.131,50.131    c27.64,0,50.126-22.488,50.126-50.131C114.16,36.358,91.673,13.869,64.032,13.869z M64.034,110.131    C38.6,110.131,17.905,89.438,17.903,64c0-25.437,20.693-46.131,46.129-46.131c25.435,0,46.128,20.694,46.128,46.131    C110.16,89.438,89.468,110.131,64.034,110.131z M78.539,68.918L66.034,79.694V43.942c0-1.104-0.896-2-2-2s-2,0.896-2,2v35.752    L49.527,68.918c-0.837-0.721-2.101-0.627-2.821,0.21s-0.627,2.101,0.21,2.821l17.118,14.748L81.15,71.949    c0.837-0.722,0.931-1.984,0.209-2.821C80.639,68.291,79.376,68.197,78.539,68.918z\" /></g></g></svg>"
set ::config_icon "<svg height='18px' id='Layer_7' style='enable-background:new 0 0 64 64' version='1.1' viewBox='3 3 78 78' width='18px' xml:space='preserve' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><path d='M78.197,37.708l-3.726-16.331l-9.873-1.097l-2.511-3.15l1.131-9.865L48.122,0l-7.008,7.028h-4.031  L30.073,0L14.979,7.266l1.131,9.865l-2.511,3.15l-9.873,1.097L0,37.708l8.413,5.271l0.898,3.928l-5.299,8.397l10.45,13.098  l9.365-3.293l3.632,1.749l3.262,9.375h16.754l3.262-9.375l3.632-1.749l9.365,3.293l10.45-13.098l-5.299-8.397l0.897-3.928  L78.197,37.708z M66.833,54.897l-5.13,6.43l-7.693-2.705l-8.12,3.911l-2.68,7.699h-8.223l-2.68-7.699l-8.12-3.911l-7.693,2.705  l-5.13-6.43L15.717,48l-2.01-8.784l-6.908-4.329l1.829-8.017l8.109-0.901l5.617-7.046l-0.93-8.101l7.41-3.567l5.758,5.773h9.012  l5.757-5.773l7.411,3.566l-0.93,8.101l5.617,7.046l8.109,0.901l1.829,8.017l-6.91,4.329L62.481,48L66.833,54.897z M39.099,23.587  c-8.286,0-15,6.713-15,15s6.714,15,15,15s15-6.713,15-15S47.385,23.587,39.099,23.587z M39.099,49.087c-5.79,0-10.5-4.71-10.5-10.5  s4.71-10.5,10.5-10.5s10.5,4.71,10.5,10.5S44.889,49.087,39.099,49.087z' style='fill:#333F4F'/></svg>"
set ::goal_icon_gray2 {<svg enable-background='new 0 0 200 200' height='18px'  version='1.1' viewBox='0 0 200 200' width='18px' xml:space='preserve' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' ><g><path d='M106.582,63.015c-4.273,4.856-7.285,9.74-8.877,14.553c-0.502,1.523-0.854,3.021-1.063,4.488   c-2.215-0.544-4.521-0.837-6.898-0.837c-16.009,0-29.036,13.028-29.036,29.036c0,16.01,13.026,29.034,29.036,29.034   c16.009,0,29.034-13.024,29.034-29.034c0-2.375-0.291-4.686-0.835-6.9c6.094-0.852,12.553-4.224,19.045-9.933   c1.877,5.267,2.906,10.931,2.906,16.833c0,27.652-22.499,50.152-50.15,50.152c-27.654,0-50.152-22.5-50.152-50.152   c0-27.653,22.498-50.15,50.152-50.15C95.649,60.104,101.318,61.136,106.582,63.015z M162.652,57.992   c-3.902,7.567-8.006,14.359-12.231,20.235c5.071,9.567,7.946,20.466,7.946,32.028c0,37.843-30.779,68.626-68.623,68.626   c-37.84,0-68.626-30.783-68.626-68.626c0-37.841,30.786-68.627,68.626-68.627c11.563,0,22.465,2.879,32.035,7.951   c5.856-4.217,12.632-8.319,20.224-12.234c-14.728-10.588-32.775-16.833-52.259-16.833C40.259,20.512,0,60.773,0,110.255   c0,49.485,40.259,89.744,89.744,89.744c49.481,0,89.743-40.259,89.743-89.744C179.487,90.771,173.241,72.722,162.652,57.992z    M92.301,97.312c-0.827-0.167-1.682-0.254-2.557-0.254c-7.28,0-13.197,5.92-13.197,13.198c0,7.278,5.917,13.197,13.197,13.197   c7.278,0,13.198-5.919,13.198-13.197c0-0.875-0.09-1.729-0.25-2.556l-8.962,6.983c-1.044,0.816-2.354,1.269-3.688,1.269   c-1.598,0-3.106-0.625-4.238-1.756c-2.135-2.138-2.344-5.549-0.485-7.928L92.301,97.312z' fill='#808080'/><path d='M168.587,36.007c6.827,1.365,21.227,3.238,27.908-3.444c10.069-10.07-3.803-25.252-13.385-15.674   c9.582-9.578-5.603-23.454-15.676-13.384c-6.678,6.68-4.805,21.079-3.442,27.906l-3.439,3.44   c-48.37,20.299-64.252,44.289-56.816,56.846l-14.027,17.998c-0.129,0.167-0.117,0.406,0.035,0.561   c0.152,0.154,0.394,0.165,0.564,0.033l17.996-14.022c12.551,7.433,36.543-8.446,56.844-56.819L168.587,36.007z' fill='#808080' /></g></svg>}
set ::goal_icon_black2 {<svg enable-background='new 0 0 200 200' height='18px'  version='1.1' viewBox='0 0 200 200' width='18px' xml:space='preserve' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' ><g><path d='M106.582,63.015c-4.273,4.856-7.285,9.74-8.877,14.553c-0.502,1.523-0.854,3.021-1.063,4.488   c-2.215-0.544-4.521-0.837-6.898-0.837c-16.009,0-29.036,13.028-29.036,29.036c0,16.01,13.026,29.034,29.036,29.034   c16.009,0,29.034-13.024,29.034-29.034c0-2.375-0.291-4.686-0.835-6.9c6.094-0.852,12.553-4.224,19.045-9.933   c1.877,5.267,2.906,10.931,2.906,16.833c0,27.652-22.499,50.152-50.15,50.152c-27.654,0-50.152-22.5-50.152-50.152   c0-27.653,22.498-50.15,50.152-50.15C95.649,60.104,101.318,61.136,106.582,63.015z M162.652,57.992   c-3.902,7.567-8.006,14.359-12.231,20.235c5.071,9.567,7.946,20.466,7.946,32.028c0,37.843-30.779,68.626-68.623,68.626   c-37.84,0-68.626-30.783-68.626-68.626c0-37.841,30.786-68.627,68.626-68.627c11.563,0,22.465,2.879,32.035,7.951   c5.856-4.217,12.632-8.319,20.224-12.234c-14.728-10.588-32.775-16.833-52.259-16.833C40.259,20.512,0,60.773,0,110.255   c0,49.485,40.259,89.744,89.744,89.744c49.481,0,89.743-40.259,89.743-89.744C179.487,90.771,173.241,72.722,162.652,57.992z    M92.301,97.312c-0.827-0.167-1.682-0.254-2.557-0.254c-7.28,0-13.197,5.92-13.197,13.198c0,7.278,5.917,13.197,13.197,13.197   c7.278,0,13.198-5.919,13.198-13.197c0-0.875-0.09-1.729-0.25-2.556l-8.962,6.983c-1.044,0.816-2.354,1.269-3.688,1.269   c-1.598,0-3.106-0.625-4.238-1.756c-2.135-2.138-2.344-5.549-0.485-7.928L92.301,97.312z' fill='#000000'/><path d='M168.587,36.007c6.827,1.365,21.227,3.238,27.908-3.444c10.069-10.07-3.803-25.252-13.385-15.674   c9.582-9.578-5.603-23.454-15.676-13.384c-6.678,6.68-4.805,21.079-3.442,27.906l-3.439,3.44   c-48.37,20.299-64.252,44.289-56.816,56.846l-14.027,17.998c-0.129,0.167-0.117,0.406,0.035,0.561   c0.152,0.154,0.394,0.165,0.564,0.033l17.996-14.022c12.551,7.433,36.543-8.446,56.844-56.819L168.587,36.007z' fill='#000000' /></g></svg>}
set ::focus_icon {<svg height='18px' viewBox='0 0 48 48' width='18px' xmlns='http://www.w3.org/2000/svg'><path d='M31 28h-1.59l-.55-.55c1.96-2.27 3.14-5.22 3.14-8.45 0-7.18-5.82-13-13-13s-13 5.82-13 13 5.82 13 13 13c3.23 0 6.18-1.18 8.45-3.13l.55.55v1.58l10 9.98 2.98-2.98-9.98-10zm-12 0c-4.97 0-9-4.03-9-9s4.03-9 9-9 9 4.03 9 9-4.03 9-9 9z'/><path d='M0 0h48v48h-48z' fill='none'/></svg>}
set ::refresh_icon {<svg enable-background='new 0 0 32 32' height='18px' id='Layer_1' version='1.1' viewBox='0 0 32 32' width='18px' xml:space='preserve' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><g><path d='M25.444,4.291c0,0-1.325,1.293-2.243,2.201C18.514,3.068,11.909,3.456,7.676,7.689   c-2.47,2.47-3.623,5.747-3.484,8.983h4C8.051,14.46,8.81,12.205,10.5,10.514c2.663-2.663,6.735-3.043,9.812-1.162   c-1.042,1.032-2.245,2.238-2.245,2.238c-0.841,1.009,0.104,1.592,0.584,1.577l5.624-0.001c0.297,0,0.539,0.001,0.539,0.001   s0.245,0,0.543,0h1.092c0.298,0,0.54-0.243,0.54-0.541V4.895C27.023,4.188,26.247,3.502,25.444,4.291z' fill='#515151'/><path d='M6.555,27.709c0,0,1.326-1.293,2.243-2.201c4.688,3.424,11.292,3.036,15.526-1.197   c2.47-2.471,3.622-5.747,3.484-8.983h-4.001c0.142,2.211-0.617,4.467-2.308,6.159c-2.663,2.662-6.735,3.043-9.812,1.161   c1.042-1.032,2.245-2.238,2.245-2.238c0.841-1.01-0.104-1.592-0.584-1.577l-5.624,0.002c-0.297,0-0.54-0.002-0.54-0.002   s-0.245,0-0.543,0H5.551c-0.298,0-0.54,0.242-0.541,0.541v7.732C4.977,27.812,5.753,28.498,6.555,27.709z' fill='#515151'/></g></svg>}
proc SVG::graph_pareto_front {args} {
    array set opt {
        x 0
        y 0
        width 200
        height 200
        data {}
        markers {1:black}
        connect {}
        x_unit {}
        y_unit {}
        z_unit {}
        x_title {}
        y_title {}
        x_type lin
        y_type lin
        title {}
        connect_pattern 2,5
        connect_width 1
        script {}
        heatmap 0
        pallet {}
        z {}
    }
    foreach {param value} $args {
        set opt($param) $value
    }
    if {$opt(script)!={}} {
        puts $::SVG::O "<script type=\"text/javascript\"><!\[CDATA\["
        puts $::SVG::O $opt(script)
        puts $::SVG::O "\]\]>"
        puts $::SVG::O </script>
    }
    if {[llength $opt(markers)]==1} {
        set order {x y}
    } else {
        set order {x y m}
    }
    SVG::text x [expr $opt(x)+$opt(width)/3-[string length $opt(title)]*2] y [expr $opt(y)-15] font-size 15  {
        print $opt(title)
    }
    set min_x 1e90
    set min_y 1e90
    set max_x -1e90
    set max_y -1e90
    set warn_log 0
    if {$opt(x_type)=="log"} {
        set log_data {}
        foreach $order $opt(data) {
            default m {}
            if {$x<=0.0} {
                set warn_log 1
                continue
            }
            set x [expr log($x)]
            lappend log_data $x
            lappend log_data $y
            if {$m!={}} {
                lappend log_data $m
            }
        }
        set opt(data) $log_data
    }
    if {$opt(y_type)=="log"} {
        set log_data {}
        foreach $order $opt(data) {
            default m {}
            if {$y<=0.0} {
                set warn_log 1
                continue
            }
            set y [expr log($y)]
            lappend log_data $x
            lappend log_data $y
            if {$m!={}} {
                lappend log_data $m
            }
        }
        set opt(data) $log_data
    }
    if {$warn_log} {
        Warning: Some graph entries were discarded because they were negative in a log-scale
    }
    foreach $order $opt(data) {
        if {$x<$min_x} {
            set min_x $x
        }
        if {$y<$min_y} {
            set min_y $y
        }
        if {$x>$max_x} {
            set max_x $x
        }
        if {$y>$max_y} {
            set max_y $y
        }
    }
    set x_min [expr $min_x-0.05*($max_x-$min_x)]
    set x_max [expr $max_x+0.05*($max_x-$min_x)]
    set y_min [expr $min_y-0.05*($max_y-$min_y)]
    set y_max [expr $max_y+0.05*($max_y-$min_y)]
    set min_x [SVG::align $x_min]
    set max_x [SVG::align $x_max]
    set min_y [SVG::align $y_min]
    set max_y [SVG::align $y_max]
    if {$opt(heatmap)} {
        <image xlink:href="http://www.engr.colostate.edu/~ystatter/hm$opt(heatmap).bmp" x="$opt(x)" y="$opt(y)" height="$opt(height)" width="$opt(width)" />  
        set key_index 0
        SVG::text x [expr $opt(x)+$opt(width)] y [expr $opt(y)+100+15*$key_index] font-size 15 text-decoration "underline" {
            print "$opt(z) \[$opt(z_unit)\]"
        }   
        incr key_index 2
        set key [lindex $opt(key) 0]
        SVG::text x [expr $opt(x)+$opt(width)] y [expr $opt(y)+100+15*$key_index] font-size 15 {
            print [eng $key $opt(z_unit)]
        }   
        incr key_index
        foreach key [lrange $opt(key) 1 end] color $opt(pallet) {
            regsub {0x} $color {#} color
            SVG::rect x [expr $opt(x)+$opt(width)] y [expr $opt(y)+85+15*$key_index] width 100 height 12 style "fill:$color"
            incr key_index
            SVG::text x [expr $opt(x)+$opt(width)] y [expr $opt(y)+100+15*$key_index] font-size 15 {
                print [eng $key $opt(z_unit)]
            }	
            incr key_index
        } 
    }	
    SVG::rect x $opt(x) y $opt(y) width $opt(width) height $opt(height) fill none stroke black stroke-width 3
    set y1_coord [expr $opt(y)+$opt(height)]
    set y2_coord [expr $y1_coord+10]
    set y3_coord [expr $y2_coord+10]
    set y4_coord [expr $y3_coord+20]
    SVG::text x [expr $opt(x)+$opt(width)/3] y $y4_coord font-size 15  {
        print "$opt(x_title)"
    }
    set xstep [get_step $min_x $max_x]
    set ystep [get_step $min_y $max_y]
    Info: xstep=$xstep ystep=$ystep
    set ::x_value [expr int($min_x/$xstep)*$xstep]
    if {$::x_value<$min_x} {
        set ::x_value [expr $::x_value+$xstep]
    }
    while {$::x_value<=$max_x} {
        set x_coord [expr $opt(x)+int($opt(width)*($::x_value-$min_x)/($max_x-$min_x))]
        Info: x_coord=$x_coord
        SVG::line x1 $x_coord y1 $y1_coord x2 $x_coord y2 $y2_coord stroke black stroke-width 3
        SVG::text x $x_coord y $y3_coord font-size 18 {
            print [eng $::x_value $opt(x_unit)]
        }
        SVG::line x1 $x_coord y1 $y1_coord x2 $x_coord y2 $opt(y) stroke black stroke-width 1 stroke-dasharray 5,5
        set ::x_value [expr $::x_value+$xstep]
    }
    set x1_coord [expr $opt(x)]
    set x2_coord [expr $x1_coord-10]
    set x3_coord [expr $x2_coord-50]
    set x4_coord [expr $x3_coord-20]
    SVG::text x $x4_coord y [expr $opt(y)+(0.8*$opt(height))] font-size 15 style "direction: rtl; writing-mode: tb; glyph-orientation-vertical: 90;" {
        print "$opt(y_title)"
    }
    set ::y_value [expr int($min_y/$ystep)*$ystep]
    if {$::y_value<$min_y} {
        set ::y_value [expr $::y_value+$ystep]
    }
    while {$::y_value<=$max_y} {
        set y_coord [expr $opt(y)+$opt(height)-int($opt(height)*($::y_value-$min_y)/($max_y-$min_y))]
        SVG::line x1 $x1_coord y1 $y_coord x2 $x2_coord y2 $y_coord stroke black stroke-width 3
        SVG::text x [expr $x4_coord+10] y $y_coord font-size 18 {
            print [eng $::y_value $opt(y_unit)]
        }
        SVG::line x1 [expr $opt(x)+$opt(width)] y1 $y_coord x2 $opt(x) y2 $y_coord stroke black stroke-width 1 stroke-dasharray 5,5
        set ::y_value [expr $::y_value+$ystep]
    }
    foreach $order $opt(data) id $::circuit_ids index $::circuit_list {
        set color green
        foreach key [lsort -unique [array names ::opt] ] {
            skip {$key=="Name"}
            skip {$key=="none"}
            skip {![info exists ::properties($key,unit)]}
            if {$::opt($key)!={}} {
                set entry [lsearch $::ref_list $key]
                set value [lindex [@ /$::SESSION(selected_topology)/circuits PAT index $index] $entry]
                if {$::properties($key,step)>0} {
                    if {$value<$::opt($key)} {
                        set color red
                    }
                } else {
                    if {$value>$::opt($key)} {
                        set color red
                    }
                }
                
            }	
        }
        set tag [lsearch $::SESSION(selected_circuits_tags) $id]
        default m 0
        set marker [split [lindex $opt(markers) $m] :]
        set radius [lindex $marker 0]
        set x_coord [expr $opt(x)+$opt(width)*($x-$min_x)/($max_x-$min_x)]
        set y_coord [expr $opt(y)+$opt(height)-$opt(height)*($y-$min_y)/($max_y-$min_y)]
        if {[regexp {[nN]} $x_coord]} continue;
        if {[regexp {[nN]} $y_coord]} continue;
        default ::SESSION(selcircuit_$id) 0
        if {$::SESSION(selcircuit_$id)} {
            <circle cx="$x_coord" cy="$y_coord" r="[expr 2*$radius]" fill="transparent" stroke="$color" stroke-width="1" visibility="visible">
            <set attributeName="visibility" from="visible" to="hidden" begin="marker$id.click"/> 
            </circle>
            <text x="[expr $x_coord-5]" y="[expr $y_coord-15]" font-size="14" fill="red" visibility="visible"> $tag
            <set attributeName="visibility" from="visible" to="hidden" begin="marker$id.click"/> 
            </text>
        } else {
            <circle cx="$x_coord" cy="$y_coord" r="[expr 2*$radius]" fill="transparent" stroke="$color" stroke-width="1" visibility="hidden">
            <set attributeName="visibility" from="hidden" to="visible" begin="marker$id.click"/> 
            </circle>
            <text x="[expr $x_coord-5]" y="[expr $y_coord-15]" font-size="14" fill="red" visibility="hidden"> $tag 
            <set attributeName="visibility" from="hidden" to="visible" begin="marker$id.click"/> 
            </text>
        }
        SVG::circle cx $x_coord cy $y_coord r $radius stroke $color stroke-width 1 fill $color id marker$id onclick "updateSelectedSpec($id)"
        <text x="[expr 1.05*$x_coord]" y="[expr 0.95*$y_coord]" font-size="20" fill="$color" visibility="hidden"> [eng $x $opt(x_unit)] [eng $y $opt(y_unit)] 
        <set attributeName="visibility" from="hidden" to="visible" begin="marker$id.mouseover" end="marker$id.mouseout"/> 
        </text>
    }
    if {$opt(connect)=="all"} {
        set opt(connect) {}
        foreach $order $opt(data) {
            default m 0
            if {[lsearch $opt(connect) $m]} {
                lappend opt(connect) $m
            }
        }    
    }
    foreach connected_marker $opt(connect) {  
        set color [lindex [split [lindex $opt(markers) $connected_marker] :] 1]
        set previous_x {}
        set previous_y {}
        foreach $order $opt(data) {
            default m -1
            skip {$m!=$connected_marker}
            set x_coord [expr $opt(x)+$opt(width)*(($x-$min_x)/($max_x-$min_x))]
            set y_coord [expr $opt(y)+$opt(height)*(1-($y-$min_y)/($max_y-$min_y))]
            if {$previous_x!={}} {
                if {$opt(connect_pattern)=="solid"} {
                    SVG::line x1 $x_coord y1 $y_coord x2 $previous_x y2 $previous_y stroke $color stroke-width $opt(connect_width) 
                } else {
                    SVG::line x1 $x_coord y1 $y_coord x2 $previous_x y2 $previous_y stroke $color stroke-width $opt(connect_width) stroke-dasharray $opt(connect_pattern)
                }
            }
            set previous_x $x_coord
            set previous_y $y_coord
        }
    }
}
default ::SESSION(selected_circuits_tags) {}
Info: [array get ::SESSION selcircuit_*]
default ::SESSION(circuit_list) {}
default ::opt(selected_circuit) {}
foreach id $::opt(selected_circuit) {
    default ::SESSION(selcircuit_$id) 0
    set ::SESSION(selcircuit_$id) 1
}
default ::opt(deselect) {}
foreach id $::opt(deselect) {
    set ::SESSION(selcircuit_$id) 0
}
Info: [array get ::SESSION selcircuit_*]
Info: QUERY_STRING=$::env(QUERY_STRING)
foreach key [array names ::opt] {
    skip {$key=="launch"}
    skip {$key=="selected_circuit"}
    set ::SESSION($key) $::opt($key)
    Info: $key=$::opt($key)
}
if {![info exists ::SESSION(selected_topology)]} return
source $::env(RAMSPICE)/Etc/Templates/$::SESSION(selected_topology)/data.tcl
set work_pat_file $::env(RAMSPICE)/Gamma/Web/FE/gamma_sessions/PAT$::active_session.db
if {[file exists $work_pat_file]} {
    @ / load $work_pat_file
} else {
    @ / load $::env(RAMSPICE)/Etc/Templates/$::SESSION(selected_topology)/pareto_bi.db
}
Info: properties=[@ /$::SESSION(selected_topology)/circuits PAT properties]
Info: sizes=[@ /$::SESSION(selected_topology)/circuits PAT sizes]
regsub -all %2C $::SESSION(selected_g) { } selected_g
regsub -all {(^|\s)\S*_} $selected_g { } selected_g
regsub -all %2C $::SESSION(selected_axes) { } selected_axes
regsub -all {(^|\s)\S*_} $selected_axes { } selected_axes
lassign $selected_axes x y z



set spec_list {}
foreach p [@ /$::SESSION(selected_topology)/circuits PAT properties] {
    if {![info exists ::opt($p)]} {
        lappend spec_list nan
        continue
    }
    if {[lsearch $selected_g $p]!=-1} {
        lappend spec_list inf
        continue
    }
    if {$::opt($p)=={}} {
        if {[lsearch $selected_axes $p]!=-1} {
            lappend spec_list inf
        } else {
            lappend spec_list nan
        }
        continue
    }
    lappend spec_list $::opt($p)
}
set axes_list {}
foreach p [@ /$::SESSION(selected_topology)/circuits PAT properties] {
    if {[lsearch $selected_axes $p]==-1} {
        lappend axes_list nan
        continue
    }
    lappend axes_list inf
}


@ /$::SESSION(selected_topology)/circuits >>> $spec_list
::SVG::out
set ::circuit_list [@ /$::SESSION(selected_topology)/circuits >>> $axes_list]
set ::SESSION(circuit_list) $::circuit_list
set retval {}
set ::ref_list [concat [@ /$::SESSION(selected_topology)/circuits PAT sizes] [@ /$::SESSION(selected_topology)/circuits PAT properties]]
set entries {}
foreach axis {x y z} {
    skip {[set $axis]=="none"}
    lappend entries [lsearch $::ref_list [set $axis]]
}    
Info: [array get ::opt]
Info: [array get ::SESSION selcircuit_*]
Info: spec_list=$spec_list
Info: axes_list=$axes_list
Info: circuit_list=$circuit_list
Info: entries=$entries
proc sort_front {a b} {
    set xa [lindex [@ /$::SESSION(selected_topology)/circuits PAT index $a] $::x_index]
    set xb [lindex [@ /$::SESSION(selected_topology)/circuits PAT index $b] $::x_index]
    if {$xb>$xa} {
        return 0
    }
    return 1
}
set ::x_index [lindex $entries 0]
set ::circuit_list [lsort -command sort_front $::circuit_list]
set ::circuit_ids {}
foreach circuit $::circuit_list {
    lappend ::circuit_ids  [@ /$::SESSION(selected_topology)/circuits PAT id $circuit]
}
Info: circuit_ids=$circuit_ids
set pixels {}
foreach index $::circuit_list {
    set circuit [@ /$::SESSION(selected_topology)/circuits PAT index $index]
    set id [@ /$::SESSION(selected_topology)/circuits PAT id $index]
    if {[lsearch $::SESSION(selected_circuits_tags) $id]==-1} {
        lappend ::SESSION(selected_circuits_tags) $id
    }
    foreach entry [lrange $entries 0 1] {
        Info: $index,$entry=[lindex $circuit $entry]
        lappend pixels [lindex $circuit $entry]
    }
}
set 3d_pixels {}
foreach index $::circuit_list {
    set circuit [@ /$::SESSION(selected_topology)/circuits PAT index $index]
    foreach entry $entries {
        lappend 3d_pixels [lindex $circuit $entry]
    }
}

set x_unit {}
if {[info exists ::properties($x,unit)]} {
    set x_unit $::properties($x,unit)
}
set y_unit {}
if {[info exists ::properties($y,unit)]} {
    set y_unit $::properties($y,unit)
}
set z_unit {}
if {[info exists ::properties($z,unit)]} {
    set z_unit $::properties($z,unit)
}
foreach dim {x y z} {
    regsub {<[^>]+>} [set ${dim}_unit] {} ${dim}_unit
}
# set z_unit m2
set rowspan 2
foreach key [lsort -unique [concat $x $y $z [array names ::opt] $selected_g]] {
    skip {$key=="Name"}
    skip {$key=="none"}
    if {[info exists ::SESSION($key)] && [lsearch $selected_g $key]==-1 && $x!=$key && $y!=$key && $z!=$key} {
        skip {$::opt($key)=={}}
        skip {![info exists ::properties($key,unit)]}
    }
    skip {![info exists ::properties($key,unit)]}
    incr rowspan
}  
incr rowspan [llength $::sizer_list]
incr rowspan [llength $selected_g]
set rowsize 15
set frame_size [expr 600+$rowsize*$rowspan]
set outer_frame_size [expr $frame_size+200]

if {[info exists $z=="none"]} {
    default ::opt(title) "$y \[$y_unit\] vs $x \[$x_unit\]"
} else {
    default ::opt(title) "$z \[$z_unit\] vs $y \[$y_unit\] vs $x \[$x_unit\]"
}
set O [open out.js w]
set selected_circuits_ids {}
set ::table_code ""
set entry_offset [llength [@ /$::SESSION(selected_topology)/circuits PAT sizes]]
append ::table_code "table+=\"<tr bgcolor='$::colors(bg)'><td></td><td></td>"
foreach property $::property_list {
    if {[catch {expr $::opt($property)+0}]} {
        set ::opt($property) {}
    }
    set property_color($property) gray
    foreach axis {x y z} {
        skip {[set $axis]!=$property}
        set property_color($property) black
    }
    if {$::opt($property)!={}} {
        set property_color($property) black
    }
    if {[lsearch $selected_g $property]!=-1} {
        set property_color($property) black
    }
    append ::table_code "<td align='center'><table><tr><td onclick=\\\"DefinePropertySpec('$property','$::opt($property)')\\\">$::config_icon</td>"
    if {$x==$property} {
        append ::table_code "<td id='X_$property' onclick=\\\"toggle_axis2(0,'$property')\\\"><font color=\\\"#000000\\\"><b>X</b></font></td>"
    } else {
        append ::table_code "<td id='X_$property' onclick=\\\"toggle_axis2(0,'$property')\\\"><font color=\\\"#808080\\\">X</font></td>"
    }
    if {$y==$property} {
        append ::table_code "<td id='Y_$property' onclick=\\\"toggle_axis2(1,'$property')\\\"><font color=\\\"#000000\\\"><b>Y</b></font></td>"
    } else {
        append ::table_code "<td id='Y_$property' onclick=\\\"toggle_axis2(1,'$property')\\\"><font color=\\\"#808080\\\">Y</font></td>"
    }
    if {$z==$property} {
        append ::table_code "<td id='Z_$property' onclick=\\\"toggle_axis2(2,'$property')\\\"><font color=\\\"#000000\\\"><b>Z</b></font></td>"
    } else {
        append ::table_code "<td id='Z_$property' onclick=\\\"toggle_axis2(2,'$property')\\\"><font color=\\\"#808080\\\">Z</font></td>"
    }
    if {[lsearch $selected_g $property]==-1} {
        append ::table_code "<td id='G_$property' onclick=\\\"toggle_g2('$property')\\\">$::goal_icon_gray2</td>"
    } else {
        append ::table_code "<td id='G_$property' onclick=\\\"toggle_g2('$property')\\\">$::goal_icon_black2</td>"
    }
    append ::table_code "<tr></tr><td colspan='4' align='center'><font color='$property_color($property)'><b>$property</b></font></td></tr></table></td>"
}
append ::table_code "<td id='SelectedCircuitID'></td></tr>\"\;\n"
append ::table_code "table+=\"<tr bgcolor=$::colors(bg)><td></td><td><b>Spec:</b></td>"
foreach property $::property_list {
    set value {}
    if {$::opt($property)!={}} {
        if {$::properties($property,step)>0} {
            append value " >"
        } else {
            append value " <"
        }
        append value [eng $::opt($property) $::properties($property,unit)]
    }
    append ::table_code "<td align='center'><b>$value</b></td>"
}
append ::table_code "<td onclick='SendSpecToServer()'>$::refresh_icon</td></tr>\"\;\n"
set j 0
foreach circuit $::circuit_ids index $::circuit_list {
    set color green
    foreach property $::property_list  {
        if {$::opt($property)!={}} {
            set entry [lsearch $::ref_list $property]
            set value [lindex [@ /$::SESSION(selected_topology)/circuits PAT index $index] $entry]
            if {$::properties($property,step)>0} {
                if {$value<$::opt($property)} {
                    set color red
                }
            } else {
                if {$value>$::opt($property)} {
                    set color red
                }
            }
            
        }   
    }
    default ::SESSION(selcircuit_$circuit) 0
    if {$::SESSION(selcircuit_$circuit)} {
        lappend selected_circuits_ids $circuit
    }
    set tag [lsearch $::SESSION(selected_circuits_tags) $circuit]
    set bgcolor [lindex {yellow orange} [expr $j%2]] 
    set bgcolor $::colors($bgcolor)
    foreach operator {== !=} {
        append ::table_code "    if ((selected_circuits.lastIndexOf($circuit)!=-1)&&(focus_circuit$operator'$circuit')) \{\n        table+=\"<tr bgcolor=$::colors(bg)><td><button onclick='DeSelect($circuit)'>X</button></td><td bgcolor=$bgcolor><font color='$color'><b>$tag</b></font></td>"
        incr j
        foreach property $::property_list {
            set entry [lsearch [@ /$::SESSION(selected_topology)/circuits PAT properties] $property]
            incr entry $entry_offset
            set value [lindex [@ /$::SESSION(selected_topology)/circuits PAT index $index] $entry]
            set font_color $property_color($property)
            if {$::opt($property)!={}} {
                if {$::properties($property,step)>0} {
                    if {$value>=$::opt($property)} {
                        set font_color green
                    } else {
                        set font_color red
                    }
                } else {
                    if {$value>=$::opt($property)} {
                        set font_color red
                    } else {
                        set font_color green
                    }
                }
            }
	    if {$operator=="=="} {
	       set bgcolor $::colors(bg)
	    } else {
               set bgcolor [lindex {yellow orange} [expr $j%2]] 
               set bgcolor $::colors($bgcolor)
	    }   
            append ::table_code "<td bgcolor=$bgcolor><font color='$font_color'> [eng [lindex [@ /$::SESSION(selected_topology)/circuits PAT index $index] $entry] $::properties($property,unit)] </font></td>"
            incr j
        }
        append ::table_code "<td><button onclick='FocusOn($circuit)'>$::focus_icon</button></td></tr>\"\;\n    \}\n"
    }
}
puts $O "selected_circuits=\[[join $selected_circuits_ids ,]\];"
puts $O "updateSpecTable = function() \{\n    var table=\"<table class='tableFormatter'>\"\;\n$::table_code    table+=\"</table>\";\n    document.getElementById(\"NewSpecTable\").innerHTML=table\;\n\}\;"
<table><tr bgcolor=$::colors(bg)>
<td colspan="2" rowspan="$rowspan" bgcolor="$::colors(bg)" class="tableFormatter" id="MapContainer">
::SVG::svg width $outer_frame_size height $outer_frame_size {
    if {$z=="none"} {
        ::SVG::graph_pareto_front x 100 y 100 width $frame_size height $frame_size data $pixels markers 6:green connect all x_title $x y_title $y x_unit $x_unit y_unit $y_unit title $::opt(title)
    } else {
        set pallet $::heatmap_pallet
        if {[info exists ::properties($z,step)]} {
            if {$::properties($z,step)<0} {
                set pallet {}
                foreach color $::heatmap_pallet {
                    set pallet [concat $color $pallet]
                }
            }
        }
        set hm /top/students/GRAD/ECE/ystatter/home/public_html/hm[pid].bmp
        set key [heatmap $3d_pixels $pallet $hm]
        ::SVG::graph_pareto_front pallet $pallet heatmap [pid] key $key x 100 y 100 width $frame_size height $frame_size data $pixels markers 6:green x_title $x y_title $y x_unit $x_unit y_unit $y_unit z $z z_unit $z_unit title $::opt(title)
    }
}
</td>
<td>
draw_schematic $::SESSION(selected_topology) [expr $frame_size-200]
</td>
</tr>
</table>
set focus_code {}
foreach circuit $::circuit_ids index $::circuit_list {
    append focus_code "if (focus_circuit=='$circuit') \{\n"
    set entry 0
    foreach size [@ /$::SESSION(selected_topology)/circuits PAT sizes] {
        foreach key [array names ::local_ids] {
            skip {$::local_ids($key)!=$size}
            set value [eng [lindex [@ /$::SESSION(selected_topology)/circuits PAT index $index] $entry] V]
            append value "<set attributeName=\\\"visibility\\\" from=\\\"hidden\\\" to=\\\"visible\\\" begin=\\\"schematic_sense_$key.mouseover\\\" end=\\\"schematic_sense_$key.mouseout\\\"/>"
            append focus_code "    document.getElementById('schematic_$key').innerHTML='$value';\n"
        }
        incr entry
    }
    append focus_code "\}\n"
}
puts $O "UpdateFocusOn=function() \{$focus_code\}\;"
close $O
save_session
return
save_session
if {![info exists ::opt(launch)]} {
    return
}

set nbcode [list array set ::SESSION [array get ::SESSION]]
append nbcode {
    set sleep_until [clock seconds]
    incr sleep_until 40
    while {[clock seconds]<$sleep_until} {}
} 
netbatch $nbcode user $::SESSION(user) Name $::SESSION(Name)
